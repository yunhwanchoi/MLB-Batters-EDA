---
title: "EDA: Salaries of MLB Batters from 1985 to 2020"
author: "Yun Hwan Choi"
output: 
  html_document:
    code_folding: hide
---
### Table of Contents
#### Introduction/Data Processing
#### Setting up/Data Merging
#### Exploratory Data Analysis 
##### I. Initial exploration
###### A. Batting Average distribution
###### B. Home Run distribution
###### C. Salary
##### II. Identifying Predictors for Postseason 
###### A. Setting up
###### B. Total Batting Average
###### C. Runs
###### D. Home Runs
###### E. Strikeouts
###### F. GIDP
###### G. Salary/Payroll
##### III. Conclusion

\
\
\
\
\

# Introduction/Data Processing

The data from the Lahman open source originally contained three dataframes, Batting.csv, BattingPost.csv, and Salaries.csv. I attempted to merge and process these by taking the following steps.\

* Cut out all data from before 1985 to make data easier to handle, and also to ensure that most data had salary information as salary information is only available from 1985. 
* To distinguish stats from regular season and Postseason, added a binary indicator variable `postseason` saying whether the statistic was from a regular season or Postseason.
* Created a new identifier variable that identifies a statistic for a player in a specific year for a specific team, for all three tables
* Merged the three datasets into one
* Added new variables `BA` (Batting average) and `Kperc` (Strikeout percentage) which can be calculated from the given information. 
* Added a new variable `postseason_app` (postseason appearance) indicating whether a team that the player played for that season ended up making it to the playoffs or not.

<br> 

These steps are outlined in the next section.

<br>

In the initial exploration stage, I attempted to confirm patterns and trends based on knowledge I have about baseball statistics. Then, via EDA, I attempted to identify the greatest determinant of a team making it into the postseason. I hypothesized that the total cumulative runs of a team in a given season would be a good predictor of the team making it to the postseason.

<br>

# Setting up/Data Merging 


Importing tidyverse package...
```{r, warning = FALSE}
library(tidyverse)
```

Loading data...
```{r, warning = FALSE}
# Loading Batting Data
batting = read_csv("data/Batting.csv")
batting_post = read_csv("data/BattingPost.csv")
salaries = read_csv("data/Salaries.csv")
```

Applying filters to select only batting data from 1985
```{r}
batting <- filter(batting, yearID >= 1985)
batting_post <- filter(batting_post, yearID >= 1985)
```

Final merged dataframe including information about each batter's season and the salary earned
```{r, warning = FALSE}
# Creating new ID key for each player and the year/team they played in
merged_batting <- bind_rows(batting, batting_post) %>% 
  unite('playerseasonID', c("yearID", "playerID", "teamID"), remove = FALSE) %>%
  mutate(
    postseason = if_else(is.na(round), 0, 1) #postseason indicator
  ) 

# Postseason appearance indicator
merged_batting_postseason_app <- merged_batting %>% group_by(playerseasonID) %>%
  summarise(postseason_app = max(postseason)) %>%
  inner_join(merged_batting, by = "playerseasonID") %>%
  mutate(postseason = if_else(postseason == 1, 'Y', 'N')) %>%
  mutate(postseason_app = if_else(postseason_app == 1, 'Y', 'N'))

# Merging with Salary Data and adding new metrics
df <- salaries %>%
  unite('playerseasonID', c("yearID", "playerID", "teamID"), remove = FALSE) %>%
  select('playerseasonID', 'salary') %>%
  right_join(merged_batting_postseason_app, by = "playerseasonID") %>% 
  mutate(BA = H/AB) %>% # batting average 
  mutate(Kperc = SO/AB) %>% # strikeout percentage
  # reordering columns 
  relocate(salary, .after = last_col()) %>%
  relocate(c(playerseasonID, playerID, yearID, teamID, stint, lgID)) %>%
  relocate(c(postseason, postseason_app, round), .after = lgID) %>%
  relocate(c(BA, Kperc), .after = AB)

df
```


# Exploratory Data Analysis


### I. Initial Exploration

Here I attempt to play around with the dataframe, and ensure whether the dataset reflects common sense knowledge about baseball.\ 

#### A. Batting Average distribution

Batting average is the most widely used metric that evaluates the level of skill of a batter. It indicates the number of hits `H` a player had divided by the number of chances ("at bats") `AB` a player was given. The higher the average, the better, meaning that the batter was able to convert a higher percentage of his opportunities to hit the ball into play. Around .240~.260 is considered average. Above .300 is considered elite. Below .200 is considered poor. On a distribution graph I expect to see a peak somewhere around .250. 

```{r, warning = FALSE}
df %>%
  ggplot() +
  geom_histogram(mapping = aes(x = BA), binwidth = 0.001)
```

We do see a peak around 0.25, but we see an incredibly high number of 0. This is most likely because the Lahman database includes data from all players, including those who may have been called up from the Minor Leagues for a short stint. Some of these players may only had less than five chances to bat (less than 5 `AB`). We can increase the minimum `AB` threshold to 100 to eliminate the 0 values. 

```{r, warning = FALSE}
df %>%
  filter(AB > 100) %>%
  ggplot() +
  geom_histogram(mapping = aes(x = BA), binwidth = 0.001)
```

This looks a lot like what we were looking for. We can increase the threshold even further to look at players who had more than 400 `AB`.
```{r, warning = FALSE}
df %>%
  filter(AB > 400) %>%
  ggplot() +
  geom_histogram(mapping = aes(x = BA), binwidth = 0.001)
```

The distribution seems very similar, although if you look closely there is a slight shift of the distribution to the right. It makes sense that players that have had a higher number of chances to bat have a higher batting average. Players that are more skilled are more likely to be given chances to bat. We can confirm this by calculating the mean for both scenarios.
```{r, warning = FALSE}
df %>%
  filter(AB > 100) %>%
  summarise(meanBA = mean(BA, na.rm = T))
df %>%
  filter(AB > 400) %>%
  summarise(meanBA = mean(BA, na.rm = T))
```

Players that had at least 400 `AB` has a mean `BA` of 0.276, while players that had at least 100 `AB` has a mean `BA` of 0.260. \
\
\
Going back to the distribution graph of minimum 400 `AB`...
```{r, warning = FALSE}
df %>%
  filter(AB > 400) %>%
  ggplot() +
  geom_histogram(mapping = aes(x = BA), binwidth = 0.001)
```

There seems to be a random spike at ~0.300. Taking a closer look...
```{r, warning = FALSE}
df %>%
  filter(AB > 400) %>%
  ggplot() +
  geom_histogram(mapping = aes(x = BA), binwidth = 0.001) +
  coord_cartesian(xlim = c(0.29, 0.31))
```

There seems to be a spike at exactly 0.300. Examining the data...

```{r, warning = FALSE}
df %>% 
  filter (AB > 400 & BA == 0.300) %>%
  select (BA, AB, H) %>%
  head()
```

There doesn't seem to be anything particularly odd or unusual. I wanted to see if there are other spikes around other "common" numbers of batting average, such as "0.250" or "0.200" to see if there was a rough estimation during data entry.

```{r, warning = FALSE}
df %>%
  filter(AB > 400) %>%
  ggplot() +
  geom_histogram(mapping = aes(x = BA), binwidth = 0.001) +
  coord_cartesian(xlim = c(0.24, 0.26))

df %>%
  filter(AB > 400) %>%
  ggplot() +
  geom_histogram(mapping = aes(x = BA), binwidth = 0.001) +
  coord_cartesian(xlim = c(0.19, 0.21))
```

No unusually high peaks exist at 0.250 or 0.200. I will conclude that the peak is purely by chance.


#### B. Home Run distribution

From my rough estimate coming from my knowledge of basic MLB stats, the average number of homeruns hit are probably around 10-15, but this number is limited to players who had a lot of `AB` exposures. Number of home runs hit in a season will have a higher variance than batting average, as it varies widely on a player by player basis.

```{r, warning = FALSE}
df %>%
  ggplot() +
  geom_histogram(mapping = aes(x = HR), binwidth = 1)
```

Again, a high number of 0 home runs. We need to bring up the `AB` threshold again.
```{r, warning = FALSE}
df %>%
  filter(AB > 400) %>%
  ggplot() +
  geom_histogram(mapping = aes(x = HR), binwidth = 1)
```

We do see a peak around 15 `HR`. There seems to be a greater right skew compared to the batting average distribution graph, which looked more like a normally distributed graph. This can be explained by the fact that there are fewer players who have a lot of power that can hit many home runs.\
\
I wanted to see if there are any statistic that correlate with the number of home runs hit. Let's filter for players that had at least 400 `AB` and above a 0.3 `BA`.
```{r, warning = FALSE}
df %>% 
  filter (AB > 400 & BA > 0.3) %>%
  ggplot() + 
  geom_histogram(mapping = aes(x = HR), binwidth = 1)
```

The graph seems slightly more normally distributed and the skew is less obvious, discounting the outliers of players who has hit more than 50 home runs. The distribution has shifted a bit right as well, hinting that a high batting average has some correlation with high numbers of homeruns hit.\
\
We can check out another statistic called `RBI`. `RBI` is short for Runs Batted In, or the number of runs a player caused to be scored. Home run hitters tend to have a high RBI. We'll see if this is a better predictor of the number of home runs hit. I will filter for players who had more than 100 RBI, which usually indicates that a player had an extremely good season. 

```{r, warning = FALSE}
df %>% 
  filter (AB > 400 & RBI > 100) %>%
  ggplot() + 
  geom_histogram(mapping = aes(x = HR), binwidth = 1)
```

The graph here has even less skew and has a more rightward shift compared to the other graphs, peaking at around 30 HRs. `RBI` seems to be a better predictor of number of `HR` hit. We can use a scatterplot to confirm this.

```{r, warning = FALSE}
df %>%
  filter (AB > 400) %>% 
  ggplot() +
  geom_point(aes(x = BA, y = HR), alpha = 1/4)
```

It's kind of hard to see a clear correlation between `BA` and `HR`. Using `RBI` instead...
```{r, warning = FALSE}
df %>%
  filter (AB > 400) %>% 
  ggplot() +
  geom_point(aes(x = RBI, y = HR), alpha = 1/4)
```

The correlation seems much more clear here. I wanted to try another variable, `BB`. `BB` or "Base on Balls", more commonly known as "walks" is the number of times a player has drawn four balls. Good players often draw more walks because the pitchers are more careful about throwing a strike to them, since there is a good chance that they will hit the ball. High home run hitters tend to have high `BB` as well. 

```{r, warning = FALSE}
df %>%
  filter (AB > 400) %>% 
  ggplot() +
  geom_point(aes(x = BB, y = HR), alpha = 1/4)
```

The correlation seems a bit better than batting average, but it is not as clear as `RBI`.

Numerically calculating the correlation coefficient:
```{r, warning = FALSE}
df %>%
  filter (AB > 400) %>%
  select(HR, BA) %>%
  cor()
df %>%
  filter (AB > 400) %>%
  select(HR, RBI) %>%
  cor()
df %>%
  filter (AB > 400) %>%
  select(HR, BB) %>%
  cor()
```

HR and RBI has the greatest correlation (0.85), as predicted.


#### C. Salary

We are given salary information in this dataframe. We can expect salary to increase over the years, considering inflation rates. We can attempt to view the distribution.

```{r, warning = FALSE}
df %>%
  ggplot() +
  geom_histogram(mapping = aes(x = salary), binwidth = 100000)
```

There is a high concentration of players receiving near 0 salary. We can attempt to remove some of them by filtering to players with over 400 `AB`.

```{r, warning = FALSE}
df %>%
  filter(AB>400) %>%
  ggplot() + 
  geom_point(mapping = aes(x = yearID, y = salary), alpha = 1/4)
```

We see a similar graph here. It's not particularly informative other than the fact that most players in the MLB receive a salary of lower than 1 million. Let's compare the salary received vs. year.

```{r, warning = FALSE}
df %>%
  filter (AB > 400) %>%
  ggplot() +
  geom_histogram(mapping = aes(x = salary), binwidth = 100000)
```

The reason the graph looks like this is because the year data is in integers (aka, no 1995.3 year) But there does seem to be a trend of rising mean salary over the years. \
\
I can convert the years from numeric to a factor type and view the years as a categorical variable, then view a boxplot for each of these years.
```{r, warning = FALSE}
df$yearIDfactor = as.factor(df$yearID)
df %>%
  ggplot(mapping = aes(x = yearIDfactor, y = salary)) +
  geom_boxplot()
```

There is a very slight trend in increase of mean salary per year, but the outliers become even higher throughout the years. We can create a separate graph only focusing on the increase of mean salary to see the numbers for them more clearly.
```{r, warning = FALSE}
df %>%
  group_by(yearID) %>%
  summarise(mean_salaries = mean(salary, na.rm = TRUE)) %>%
  ggplot() +
  geom_line(mapping = aes(x = yearID, y = mean_salaries))
```

We can see the mean salary increase from lower than 1 million from 1985 to around 5 million in 2016. However, the outliers (players with some of the highest paid salaries) underwent an even more dramatic increase as evidenced by the boxplot, some receiving over 30 million dollars a year. This can be explained by a dramatic increase in MLB teams' revenues in recent years.\
\
We will return to salaries for a more in depth analysis.

### II. Identifying Predictors for Postseason 

We will attempt to identify variables that would predict a team's likelihood of entering the postseason (a period in the end of the MLB regular season where the best teams compete for the World Series Title in a tournament fashion) 

#### A. Setting up 

Because we are now talking in terms of teams, I created a new dataframe that contains statistic of a team's season by merging the data with group_by.

I also created new variables that measures the ratio of these statistics for a whole team's season. The team's collective batting average `total_BA`, the team's collective strikeout percentage `total_Kperc`, etc. `GIDP` refers to "Grounded in double play" which is a bad thing for the batter and produces two outs.

```{r, warning = FALSE}
teamsummary <- df %>%
  group_by(yearID, teamID) %>%
  summarise(total_AB = sum(AB, na.rm=TRUE), total_H = sum(H, na.rm=T), 
            total_HR = sum(HR, na.rm = T),  total_R = sum(R, na.rm = T), 
            total_SO = sum(SO, na.rm = T), total_salary = sum(salary, na.rm = T), 
            total_GIDP = sum(GIDP, na.rm = T)) %>%
  mutate(total_BA = total_H/total_AB, 
         total_Kperc = total_SO/total_AB, 
         total_HRperc = total_HR/total_AB,
         total_RRatio = total_R/total_AB,
         total_GIDPperc = total_GIDP/total_AB) %>%
  arrange(yearID, teamID)
head(teamsummary)
```

I then left merged this dataframe with another dataframe only containing the team's postseason appearance status by creating a new dataframe only containing the team, its year, and the postseason appearance stats `postseason_app`. Code is shown below
```{r, warning = FALSE}
teamsPSapp <- df %>% 
  select(teamID, yearID, postseason_app) %>%
    unique()
teamsummary <- left_join(teamsummary, teamsPSapp, by = c("teamID", "yearID")) %>%
  select(yearID, teamID, postseason_app, total_BA, total_Kperc, 
         total_HRperc, total_RRatio, total_GIDPperc, total_salary, everything())%>%
  arrange(yearID, teamID) 
```

Finally, I included another variable that displays the `yearID` as factors instead of integers.
```{r, warning = FALSE}
teamsummary$yearIDfactor = as.factor(teamsummary$yearID)
head(teamsummary)
```

##### B. Total Batting Average

Can we predict a team's likelihood to enter the postseason by looking at the team's collective batting average? 

```{r, warning = FALSE}
teamsummary %>%
  ggplot(mapping = aes(x = total_BA)) + 
  geom_freqpoly(mapping = aes(colour = postseason_app), binwidth = 0.003) +
  labs(x = "Season Batting Average", y = "Count", colour = "Postseason Appearance")
```

We would be comparing the shift and the pattern of the graph rather than the scale of these graphs, since there are obviously more data points for teams that didn't make the postseason. There doesn't seem like an obvious correlation, since the shape is pretty similar between the two graphs. 

##### C. Runs

```{r, warning = FALSE}
teamsummary %>%
  ggplot(mapping = aes(x = total_R)) + 
  geom_freqpoly(mapping = aes(colour = postseason_app), binwidth = 10) +
  labs(x = "Total Runs", y = "Count", colour = "Postseason Appearance")
```

It seems that the postseason graph is more skewed left (with a more rightward peak), meaning that teams that appeared on the postseason tend to have higher runs. Team's total runs do seem like a better indicator at least compared to the collective batting average. We can see a similar trend with `total_RRatio`, or a team's calculated run per At Bat. 
```{r, warning = FALSE}
teamsummary %>%
  ggplot(mapping = aes(x = total_RRatio)) + 
  geom_freqpoly(mapping = aes(colour = postseason_app), binwidth = 0.003) +
  labs(x = "Total Runs per AB", y = "Count", colour = "Postseason Appearance")
```

Although the postseason team's graph seems a bit more rightward, I think that `total_R` is a better indicator of a team's postseason appearance likelihood. This makes sense given that a team's win is determined by the hard number of runs scored, not "run scored per at bat."

##### D. Homeruns

```{r, warning = FALSE}
teamsummary %>%
  ggplot(mapping = aes(x = total_HR)) + 
  geom_freqpoly(mapping = aes(colour = postseason_app), binwidth = 5) +
  labs(x = "Total Home Runs", y = "Count", colour = "Postseason Appearance")
```

This is a similar graph to above `Total Runs` graph. There is an obvious skew left (rightward shift) for the postseason graph compared to the regular season graph. This makes sense because the number of home runs is directly correlated with the number of runs scored by a team. 

```{r, warning = FALSE}
teamsummary %>%
  ggplot(mapping = aes(x = total_HRperc)) + 
  geom_freqpoly(mapping = aes(colour = postseason_app), binwidth = 0.001) +
  labs(x = "Total Runs per AB", y = "Count", colour = "Postseason Appearance")
```

Again, the HR ratio graph is similar to the Run ratio graph. You can see a clear rightward shift by the postseason graph, but it's not as evident as the "Total home run" graph. 

##### E. Strikeouts

Because strikeouts are bad for the team, would we see an opposite trend here compared to the above graphs?
```{r, warning = FALSE}
teamsummary %>%
  ggplot(mapping = aes(x = total_HRperc)) + 
  geom_freqpoly(mapping = aes(colour = postseason_app), binwidth = 0.001) +
  labs(x = "Total Runs per AB", y = "Count", colour = "Postseason Appearance")
```

The postseason graph for Total Strikeouts actually has a slight rightward shift. Does this suggest that a team's high strikeout count positively predicts the likelihood of a postseason appearance? We can also look at the collective strikeout rate of a team.

```{r, warning = FALSE}
teamsummary %>%
  ggplot(mapping = aes(x = total_Kperc)) + 
  geom_freqpoly(mapping = aes(colour = postseason_app), binwidth = 0.01) +
  labs(x = "Total SO Rate", y = "Count", colour = "Postseason Appearance")
```

When looking at the strikeout rate rather than the count, the shift is not as obvious now. The postseason teams graph actually seems a bit more leftward-shifted. Strikeout rate is actually a better indicator of a team's skill than hard counts of how many strikeouts a team had. Contrary to "runs", the number of "strikeouts" a team accumulates doesn't necessarily lead to affecting the points in a game. A team with a high strikeout rate indicates that they are not able to efficiently convert opportunities to a productive play. A team with a high strikeout **count** can also have a low strikeout rate. \
\

##### F. GIDP 

This logic is similar to `GIDP`, or "grounded in double play" counts/rates.
```{r, warning = FALSE}
teamsummary %>%
  ggplot(mapping = aes(x = total_GIDP)) + 
  geom_freqpoly(mapping = aes(colour = postseason_app), binwidth = 5) +
  labs(x = "Total GIDP", y = "Count", colour = "Postseason Appearance")
```

```{r, warning = FALSE}
teamsummary %>%
  ggplot(mapping = aes(x = total_GIDPperc)) + 
  geom_freqpoly(mapping = aes(colour = postseason_app), binwidth = 0.0007) +
  labs(x = "Total GIDP rate", y = "Count", colour = "Postseason Appearance")
```

Both strikeout counts/rates and GIDP counts/rates are not as great predictor of a team's postseason appearance likelihood, compared to the number of runs and home runs that a team accumulates throughout the season. \
\
These scatterplots confirm that runs matter more than K rate and GIDP rate in determining a team's postseason appearance likelihood.
```{r}
teamsummary %>%
  ggplot(mapping = aes(x = total_R, y = total_Kperc)) +
  geom_point(aes(colour = postseason_app))

teamsummary %>%
  ggplot(mapping = aes(x = total_R, y = total_GIDPperc)) +
  geom_point(aes(colour = postseason_app))
```

##### G. Salary/Payroll

A team's payroll is defined as how much money it spends on hiring a player. We have the payroll data for each teams. It's not completely accurate, as there are some salary data that is not available, but there is data for most players, so this is the best we could do.

```{r, warning = FALSE}
teamsummary %>%
  ggplot(mapping = aes(x = total_salary)) + 
  geom_freqpoly(mapping = aes(colour = postseason_app), binwidth = 5000000)+
  labs(x = "Team's payroll", y = "Count", colour = "Postseason Appearance")
```

On points that exceed 20 million (20e+08), we can see that there are only spikes visible for the graph of postseason teams. Amount of money a team spends on a player seems to be a fairly good indicator of a team's performance and its likelihood to make it into the postseason.\
\
We can confirm this though a covariance relationship of total salary and total runs scored. 
```{r, warning = FALSE}
teamsummary %>%
  ggplot(mapping = aes(x = total_R, y = total_salary)) +
  geom_point(aes(colour = postseason_app))+
  labs(x = "Team Total Runs", y = "Team Payroll", colour = "Postseason Appearance")
```

This graph clearly shows that salary is a dominant factor in determining a team's postseason appearance likelihood. We can see that teams above a certain payroll (around 25 million) all make it into the postseason, despite how many runs they scored! We can see a similar trend with payroll vs. homeruns.

```{r, warning = FALSE}
teamsummary %>%
  ggplot(mapping = aes(x = total_R, y = total_salary)) +
  geom_point(aes(colour = postseason_app)) +
  labs(x = "Team Total Runs", y = "Team Payroll", colour = "Postseason Appearance")

teamsummary %>%
  ggplot(mapping = aes(x = total_HR, y = total_salary)) +
  geom_point(aes(colour = postseason_app)) +
  labs(x = "Team Total Home Runs", y = "Team Payroll", colour = "Postseason Appearance")
```

Through EDA we could see that a team's payroll (total salary paid) is the most determinant factor of a team's postseason apperance, then the number of runs and home runs scored, then the rate of Strikeouts/GIDPs, then finally the collective batting average of a team. 

### Conclusions

In the initial data exploration, EDA of the Lahman dataset confirms the "common sense" trends of baseball. The result from the second part disproves my original hypothesis that the total runs scored is the greatest determinant of a team's likelihood of reaching the postseason. As determined by EDA, payroll can have a great deal of variance with a lot of outliers. This means that teams with a high payroll would have spent a lot of money on particular players that perform extremely well. Although baseball is known as a team sport that is notoriously difficult to predict the results of, this conclusion suggests that having key individual players can have an immense impact in a team's performance. The error of my original hypothesis suggests that I overemphasized collective performance over performance due to individual contribution. 



